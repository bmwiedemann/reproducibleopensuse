#!/bin/sh -e
# rebuild with KVM mode
: ${slot:=4}
: ${clean:=--clean --offline}
: ${project:=home:bmwiedemann:reproducible}
: ${datediff:=$((((401*24+13)*60+17)*60))}
now=$(date +%s)
later=$(date --date=@$((now+datediff)) -u "+%FT%T")
export vmtype="--vm-type=kvm"
export OSC_BUILD_ROOT=/var/tmp/build-root.${slot}/
export VM_CUSTOMOPT=""
osc up
osc build --preload --nopreinstallimage --noservice --vm-type=kvm --alternative-project=$project
clean+=" --release=0.0 -j4"
export clean
HOST=sles12a OUTDIR=RPMS.2017 rebuild &
pid=$!
export VM_CUSTOMOPT="-rtc base=$later"
export OSC_BUILD_ROOT=/var/tmp/build-root.${slot}b/
HOST=sles12b OUTDIR=RPMS rebuild
wait $pid
dir1=RPMS.2017 compareone
