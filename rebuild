#!/bin/sh

: ${OSC_BUILD_ROOT:="/var/tmp/build-root/standard-x86_64"}
: ${clean:=--clean}
: ${OUTDIR:=RPMS}
export OSC_BUILD_ROOT
if grep -q "^$(basename $(pwd))$" ~/reproducibleopensuse/exceptions.cleanbuild ; then
  clean=${clean/--noinit/--clean}
fi
if grep -q "^$(basename $(pwd))$" ~/reproducibleopensuse/exceptions.rootforbuild ; then
  rootforbuild=" --userootforbuild"
fi

#vmtype="--vm-type=kvm"
rm -rf $OSC_BUILD_ROOT/home/abuild/rpmbuild/RPMS/ $OSC_BUILD_ROOT/.mount/.build.packages/RPMS/ $OSC_BUILD_ROOT/.build.log
rm -rf $OUTDIR
mkdir -p $OUTDIR
osc build --alternative-project home:bmwiedemann:reproducible --nopreinstallimage --disable-debuginfo --noservice$rootforbuild $vmtype $clean $(basename `pwd`).spec "$@" 2>&1 | tee $OUTDIR/.build.log2
echo ${PIPESTATUS[0]} > $OUTDIR/.osc-build-retval
cp -a $OUTDIR/.osc-build-retval .
cp -a $OSC_BUILD_ROOT/.build.log $OUTDIR/
cp -a $OUTDIR/.build.log .
ntpdate -p 1 ntp.zq1.de ntp.suse.de
find -mtime -0 -print0 | xargs --no-run-if-empty -0 touch
if [ `cat $OUTDIR/.osc-build-retval` -gt 0 ] ; then
    exit 1
fi
rpmdir="$OSC_BUILD_ROOT/home/abuild/rpmbuild/RPMS"
[[ $rootforbuild ]] && rpmdir="$OSC_BUILD_ROOT/usr/src/packages/RPMS"
cp -a $rpmdir/*/*.rpm $OSC_BUILD_ROOT/.mount/.build.packages/RPMS/*/*.rpm $OUTDIR/
test -n "$(find $OUTDIR/ -maxdepth 1 -name '*.rpm' -print -quit)"
